<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>70城商品住宅销售价格变动数据</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; margin: 24px; }
    h1 { margin-bottom: 8px; }
    .controls { display: flex; flex-wrap: wrap; gap: 12px; margin: 16px 0; }
    label { font-size: 14px; }
    select, input { padding: 6px 8px; font-size: 14px; }
    table { border-collapse: collapse; width: 100%; margin-top: 12px; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; text-align: right; }
    th { background: #f5f5f5; }
    td.city, th.city { text-align: left; }
    .muted { color: #666; font-size: 12px; }
  </style>
</head>
<body>
  <h1>70个大中城市商品住宅销售价格变动</h1>
  <div class="muted">数据来源：国家统计局</div>

  <div class="controls">
    <label>城市
      <input id="cityInput" placeholder="输入城市名（例如：杭州）" />
    </label>
    <label>房屋类型
      <select id="houseSelect">
        <option value="新房">新房</option>
        <option value="二手房">二手房</option>
      </select>
    </label>
    <label>维度
      <select id="segmentMode">
        <option value="整体">整体</option>
        <option value="面积段">面积段</option>
      </select>
    </label>
    <label>展示
      <select id="displayMode">
        <option value="index">环比/同比</option>
        <option value="price">相对价格序列(基期=100)</option>
      </select>
    </label>
    <label id="segmentWrap">面积段
      <select id="segmentSelect">
        <option value="">全部</option>
      </select>
    </label>
    <button id="resetBtn">重置</button>
  </div>

  <canvas id="chart" height="120"></canvas>
  <div class="muted">说明：同比=本月价格指数相对上年同月(上年同月=100)；环比=本月价格指数相对上月(上月=100)。</div>
  <div class="muted">显示范围：2018-03 至 2025-12</div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script>
    async function loadCsv(path) {
      const res = await fetch(path);
      const text = await res.text();
      return new Promise((resolve) => {
        Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          complete: (results) => resolve(results.data),
        });
      });
    }

    function inRange(month) {
      return month >= '2018-03' && month <= '2025-12';
    }

    function buildSeries(rows, mode, displayMode) {
      const labels = Array.from(new Set(rows.map(r => r.month))).sort();
      const groupKey = mode === '整体' ? 'metric' : 'segment';
      const groups = Array.from(new Set(rows.map(r => r[groupKey])));
      const datasets = [];
      groups.forEach(g => {
        const gRows = rows.filter(r => r[groupKey] === g);
        if (displayMode === 'price') {
          datasets.push({
            label: g,
            data: labels.map(m => {
              const row = gRows.find(r => r.month === m);
              return row ? Number(row.value) : null;
            }),
            borderWidth: 2,
            tension: 0.2,
          });
        } else {
          if (mode === '整体') {
            datasets.push({
              label: g,
              data: labels.map(m => {
                const row = gRows.find(r => r.month === m);
                return row ? Number(row.value) : null;
              }),
              borderWidth: 2,
              tension: 0.2,
            });
          } else {
            ['环比','同比'].forEach(metric => {
              const mRows = gRows.filter(r => r.metric === metric);
              datasets.push({
                label: `${g}-${metric}`,
                data: labels.map(m => {
                  const row = mRows.find(r => r.month === m);
                  return row ? Number(row.value) : null;
                }),
                borderWidth: 2,
                tension: 0.2,
              });
            });
          }
        }
      });
      return { labels, datasets };
    }

    let chart;
    function renderChart(rows, mode, displayMode) {
      const ctx = document.getElementById('chart').getContext('2d');
      const { labels, datasets } = buildSeries(rows, mode, displayMode);
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } },
          scales: { x: { ticks: { maxRotation: 0 } } },
        },
      });
    }

    function applyFilter(indexData, priceData) {
      const city = document.getElementById('cityInput').value.trim();
      const house = document.getElementById('houseSelect').value;
      const mode = document.getElementById('segmentMode').value;
      const seg = document.getElementById('segmentSelect').value;
      const displayMode = document.getElementById('displayMode').value;
      const data = (displayMode === 'price') ? priceData : indexData;
      let rows = data.filter(r => inRange(r.month));
      rows = rows.filter(r => r.house_type === house);
      if (city) rows = rows.filter(r => r.city.includes(city));
      if (mode === '整体') {
        rows = rows.filter(r => r.segment === '整体');
      } else {
        rows = rows.filter(r => r.segment !== '整体');
        if (seg) rows = rows.filter(r => r.segment === seg);
      }
      renderChart(rows, mode, displayMode);
    }

    Promise.all([loadCsv('./chart.csv'), loadCsv('./price.csv')]).then(([indexData, priceData]) => {
      const segmentSelect = document.getElementById('segmentSelect');
      const segmentWrap = document.getElementById('segmentWrap');
      const segments = Array.from(new Set(indexData.map(r => r.segment))).filter(s => s && s !== '整体');
      const labelMap = {
        '90m2及以下': '90㎡以下',
        '90-144m2': '90-144㎡',
        '144m2以上': '144㎡以上',
      };
      segments.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        opt.textContent = labelMap[s] || s;
        segmentSelect.appendChild(opt);
      });

      function toggleSegment() {
        const mode = document.getElementById('segmentMode').value;
        segmentWrap.style.display = (mode === '面积段') ? 'inline-block' : 'none';
      }

      document.getElementById('resetBtn').addEventListener('click', () => {
        document.getElementById('cityInput').value = '';
        document.getElementById('segmentSelect').value = '';
        applyFilter(indexData, priceData);
      });

      document.getElementById('cityInput').addEventListener('input', () => applyFilter(indexData, priceData));
      document.getElementById('houseSelect').addEventListener('change', () => applyFilter(indexData, priceData));
      document.getElementById('segmentMode').addEventListener('change', () => {
        toggleSegment();
        applyFilter(indexData, priceData);
      });
      document.getElementById('segmentSelect').addEventListener('change', () => applyFilter(indexData, priceData));
      document.getElementById('displayMode').addEventListener('change', () => applyFilter(indexData, priceData));

      toggleSegment();
      applyFilter(indexData, priceData);
    });
  </script>
</body>
</html>
